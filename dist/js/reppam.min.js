/**
 * ys-reppam - Reppam a mapping function used in conjuction with google maps API
 * @version v0.0.1
 * @link http://youngskilled.com
 * @author richard@youngskilled.com Young/Skilled
 * @license MIT
 */
!function(e,t){t.reppamCallback=function(){e(t).trigger("scriptLoaded.reppam")};var a={init:function(){var o=this,n=o.set.urlParams,s=o.set.mapsURL+"?callback=window.reppamCallback";if("undefined"==typeof google){for(var r in n)s+="&"+r+"="+n[r];e.ajax({url:s,dataType:"script",error:function(e){o.set.debug&&console.log("Google maps has failed to load, message: "+e)}})}else e(t).trigger("scriptLoaded.reppam");e(t).on("scriptLoaded.reppam",function(){a.getData.apply(o)})},getData:function(){var t=this,o=[];t.on("markersLoaded.reppam countriesLoaded.reppam",function(e,n){o.push(n),2===o.length&&a.renderMap.apply(t)}),e.ajax({url:t.set.markersUrl,type:"GET",dataType:"JSON",success:function(e){t.set.markersData=e,t.data("markersData",e),t.trigger("markersLoaded.reppam","markers")},error:function(e){t.set.debug&&console.log("Markers data has failed to load, message: "+e)}}),e.ajax({url:t.set.countriesUrl,type:"GET",dataType:"JSON",success:function(e){t.set.countriesData=e,t.trigger("countriesLoaded.reppam","countries"),t.data("countriesData",e)},error:function(e){t.set.countriesData=!1,t.trigger("countriesLoaded.reppam","countries"),t.set.debug&&console.log("Countries failed to load, message: "+e),t.data("countriesData",data)}})},renderMap:function(){var e,t,o,n,s=this;s.set.countriesData&&(e=s.set.countriesData[s.set.markersData.currentLocation[0]],s.set.defaultCountry!==!1&&(a.withinBounds(e.sw,e.ne,s.set.markersData.locations)||(e=s.set.countriesData[s.set.defaultCountry])),t=new google.maps.LatLng(e.sw.lat,e.sw.lng),o=new google.maps.LatLng(e.ne.lat,e.ne.lng),n=new google.maps.LatLngBounds(t,o)),s.set.map=new google.maps.Map(s[0],s.set.mapOptions),s.set.countriesData&&s.set.map.fitBounds(n),s.data("map",s.set.map),a.logPosition.apply(s),a.enableEvents.apply(s),a.addMarkers.apply(s)},enableEvents:function(){var o=this;e("#locate-me").on("click",function(t){t.preventDefault();var n=e(this);n.addClass("loading"),a.getLocation(function(e){a.addMe.apply(o,[e]),n.removeClass("loading").addClass("loaded")})}),e("#nearest").on("click",function(t){t.preventDefault();var n,s,r,i=e(this),l=[];i.addClass("loading"),a.getLocation(function(e){var t;a.addMe.apply(o,[e]),o.set.current.crowFlies&&o.set.current.crowFlies.setMap(null),i.removeClass("loading").addClass("loaded"),l=a.findNearest(e,o.set.markersData.locations),n=new google.maps.LatLng(e.lat,e.lng),s=new google.maps.LatLng(l[0].data.latitude,l[0].data.longitude),t=new google.maps.Polyline({path:[n,s],geodesic:!0,strokeColor:o.set.strokeColor,strokeWeight:3}),google.maps.event.addListener(t,"click",function(){r=new google.maps.LatLngBounds,r.extend(n),r.extend(s),o.set.map.fitBounds(r),a.logPosition.apply(o)}),t.setMap(o.set.map),l[0].distance<100?(r=new google.maps.LatLngBounds,r.extend(n),r.extend(s),o.set.map.fitBounds(r)):(o.set.map.setCenter(s),o.set.map.setZoom(o.set.zoomedIn)),o.set.current.crowFlies=t,a.logPosition.apply(o)})}),e(t).on("resize",function(){o.set.map.setCenter(o.set.center),o.set.map.setZoom(o.set.zoom)})},addMe:function(e){var t,o,n=this;n.set.current.position&&n.set.current.position.setMap(null),o=new google.maps.LatLng(e.lat,e.lng),t=new google.maps.Marker({position:o,icon:n.set.personMarker}),t.setMap(n.set.map),n.set.map.setCenter(o),google.maps.event.addListener(t,"click",function(){n.set.map.getZoom()<n.set.zoomedIn&&n.set.map.setZoom(n.set.zoomedIn),n.set.map.panTo(this.getPosition()),a.logPosition.apply(n)}),n.set.current.position=t},addMarkers:function(){var e,t,o,n,s=this,r=s.set.markersData.locations,i=[];for(var l in r)t=r[l],""!==t.latitude&&""!==t.longitude&&(e=new google.maps.LatLng(t.latitude,t.longitude),o=new google.maps.Marker({id:l,content:r[l].address,position:e,title:r[l].name,icon:s.set.singleMarker}),google.maps.event.addListener(o,"click",function(){var e=new google.maps.InfoWindow({content:this.content});s.set.current.infoWindow&&s.set.current.infoWindow.close(),s.set.map.getZoom()<s.set.zoomedIn&&this.id===s.set.current.viewed&&s.set.map.setZoom(s.set.zoomedIn),s.set.map.panTo(this.getPosition()),e.open(s.set.map,this),s.set.current.infoWindow=e,s.set.current.viewed=this.id,a.logPosition.apply(s)}),i.push(o));if(void 0!==MarkerClusterer)n=new MarkerClusterer(s.set.map,i,{maxZoom:s.set.zoomedIn-1}),n.setStyles([s.set.multipleMarker]);else for(var d=0;d<i.length;d++)i[d].setMap(s.set.map)},logPosition:function(){var e=this;e.set.center=e.set.map.getCenter(),e.set.zoom=e.set.map.getZoom()},moveToMarker:function(e,t){var a,o=this,n=o.set.markersData.locations[e];return t=t||function(){},""===n.latitude||""===n.longitude?(o.set.debug&&console.log("This location has no coordinates."),t({success:!1})):(a=new google.maps.LatLng(n.latitude,n.longitude),o.set.map.setCenter(a),o.set.map.setZoom(o.set.zoomedIn),t({success:!0}))},moveToCoords:function(e){var t,a=this;return e.callback=e.callback||function(){},e.lat&&e.lng&&e.zoom?(t=new google.maps.LatLng(e.lat,e.lng),a.set.map.setCenter(t),a.set.map.setZoom(e.zoom),e.callback({success:!0})):(a.set.debug&&console.log("Coordinates need all the values. Latitude, longitude and zoom lat:"+e.lat+" lng: "+e.lng+" zoom: "+e.zoom),e.callback({success:!1}))},getLocation:function(e){var t;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){return t={lat:a.coords.latitude,lng:a.coords.longitude},"function"==typeof e?e(t):void 0},function(){handleNoGeolocation(!0)}):handleNoGeolocation(!1)},withinBounds:function(e,t,a){var o,n,s,r=!1;for(o in a)if(n=!1,s=a[o],s.latitude>e.lat&&s.latitude<t.lat&&(n=!0),n&&s.longitude>e.lng&&s.longitude<t.lng){r=!0;break}return r},findNearest:function(e,t){var o,n,s=[],r=0;for(o in t)n={lat:t[o].latitude,lng:t[o].longitude},s[r]={id:o,distance:a.haversine(e,n),data:t[o]},r++;return s.sort(function(e,t){return e.distance-t.distance}),s},radians:function(e){return e*Math.PI/180},haversine:function(e,t){var o=6371,n=a.radians(t.lat-e.lat),s=a.radians(t.lng-e.lng),r=Math.sin(n/2)*Math.sin(n/2)+Math.cos(a.radians(e.lat))*Math.cos(a.radians(t.lat))*Math.sin(s/2)*Math.sin(s/2),i=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)),l=o*i;return Math.round(l)}},o={init:function(t){return this.each(function(){var o=e(this),r=o.data();o.set=e.extend({},n,t,r,s),a.init.apply(o),o.data(o.set)})},showOnMap:function(t){return this.each(function(){{var o=e(this);o.data()}o.set=e.extend({},o.data()),a.moveToMarker.apply(o,[t.id,t.callback]),o.data(o.set)})},showCoords:function(t){return this.each(function(){{var o=e(this);o.data()}o.set=e.extend({},o.data()),a.moveToCoords.apply(o,[t]),o.data(o.set)})},update:function(t){return this.each(function(){var o=e(this);o.set=e.extend({},o.data(),t),a.update.apply(o),o.data(o.set)})},destroy:function(t){return this.each(function(){var a=e(this);a.set=e.extend({},a.data(),t,s)})}},n={debug:!1,mapsURL:"//maps.google.com/maps/api/js",urlParams:{},countriesUrl:"countries.json",defaultCountry:!1,markersUrl:"markers.json",mapOptions:{},multipleMarker:{},singleMarker:{},personMarker:{},zoomedIn:14,strokeColor:"#000000"},s={center:void 0,current:{infoWindow:void 0,position:void 0,nearestStore:void 0,crowFlies:void 0}};e.fn.reppam=function(t){return o[t]?o[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.reppam"):o.init.apply(this,arguments)}}(jQuery,window);